{{define "page/index"}}
{{template "common/header" .}}
{{template "common/user_nav" .}}
<div class="ui container segment clear-shadow-and-border">
  <div class="ui card">
    <div class="image"><img src="{{if .user.Avatar}}/upload/avatar/{{.user.ID}}{{else}}/static/assets/favicon.png{{end}}" /></div>
    <div class="content">
      <a class="header">{{.user.Username}}</a>
      <div class="meta"><span class="date">{{.user.CreatedAt}} 加入</span></div>
      <div class="description">
        {{if .user.Bio}}{{.user.Bio}}{{else}}该用户很神秘，并没有留下简介。{{end}}
      </div>
    </div>
    <div class="ui bottom attached button" onclick="showEditProfile()"><i class="edit icon"></i> 修改资料 </div>
    <div id="editProfile" class="ui modal">
      <div class="header">
        <i class="edit icon"></i>
        修改资料
      </div>
      <div class="content">
        <form id="editProfileForm" class="ui form">
          <div class="inline field">
            <label>头像</label>
            <input name="avatar" type="file">
          </div>
          <div class="inline field">
            <label>用户名</label>
            <input name="username" type="text" value="{{.user.Username}}" placeholder="英文或数字">
          </div>
          <div class="inline field">
            <label>简介</label>
            <input name="bio" type="text" autocomplete="nickname" value="{{.user.Bio}}">
          </div>
          <div class="inline field">
            <label>新密码</label>
            <input name="password" type="password" autocomplete="new-password" placeholder="至少 6 位">
          </div>
          <div class="inline field">
            <label>确认密码</label>
            <input name="repassword" type="password" autocomplete="new-password" placeholder="确认密码">
          </div>
          <div class="ui error message">

          </div>
          <div class="ui message">
            <p>头像更新有缓存，请不要着急。</p>
          </div>
        </form>
      </div>
      <div class="actions">
        <div class="ui cancel button">
          <i class="remove icon"></i>
          取消
        </div>
        <div onclick="editProfile()" class="ui green button">
          <i class="checkmark icon"></i>
          保存
        </div>
      </div>
      </di>
    </div>
  </div>
</div>
<script>
  function showEditProfile() {
    setFormError('#editProfileForm')
    $('#editProfile').modal('show')
  }
  // 设置表单错误
  function setFormError(ele, errors) {
    var fields = $(ele + ' .field');
    var map = {}
    for (let i = 0; i < fields.length; i++) {
      const element = fields[i];
      map[element.firstElementChild.textContent] = element
      if (!errors) {
        $(element).removeClass('error')
      }
    }
    if (errors) {
      $(ele).addClass('error')
      var errHtml = '<ul>';
      Object.keys(errors).forEach(k => {
        $(map[k.split('.')[1]]).addClass('error')
        errHtml += '<li>' + errors[k] + '</li>'
      });
      errHtml += '</ul>'
      $(ele + ' .ui.error.message').html('<div class="header">您的输入不规范</div>' + errHtml)
    } else {
      $(ele).removeClass('error')
      $(ele + ' .ui.error.message').html('')
    }
  }
  function editProfile() {
    $('#editProfileForm').addClass("loading")
    $.ajax({
      url: '/profile',
      type: 'PATCH',
      cache: false,
      data: new FormData($('#editProfileForm')[0]),
      processData: false,
      contentType: false
    }).done((res) => {
      $('#editProfile').modal('hide')
    }).fail((res) => {
      setFormError('#editProfileForm', res.responseJSON)
    }).always(() => {
      $('#editProfileForm').removeClass("loading")
    })
  }
</script>
{{template "common/footer" .}}
{{ end }}